#! /bin/bash

###########################
# THis is the shell script to process the raw SEER data.
# please save this script in .sh format.
###########################

ExtractSubtype(){
  if [ $# -eq 4 ]
  then
    cut -f $3 $1 | grep -n -w -Ff $2 | cut -f 1 -d ":" | cat | while read line
    do
    head -"$line" $1 | tail -1 >> $4
    done
  else
  echo "dataFile subtypeFile columnNumber outputFile"
  fi
}

# how to run this functions: ExtractSubtype dataFile subtypeFile columnNumber outputFile

# define the data file and the files contains the barcode for each subtype. We generate those .txt files using R.
dataFile=$(find -name "*_seperated.txt" | sed -s 's/^..//')
subtypeFile=$(ls ./subtype)

### using two loops to run function ExtractSubtype. However, this method is not efficient. It's better run parallel jobs in cluster
for i in $dataFile
do 
   for j in $subtypeFile
   do 
        ExtractSubtype "$i" ./subtype/"$j" 12 ./data_subtype/"$j"_data.txt
   done
done


## after parsing the data by tissue types, we add colum names to the matrix
for i in $(find -name *.TXT)
do

export temp=".TXT"
export fileName=${i%$temp}

cat $i  | sed -r 's/./&\t/356;s/./&\t/354;s/./&\t/352;s/./&\t/351;s/./&\t/350;s/./&\t/349;s/./&\t/348;s/./&\t/347;s/./&\t/341;s/./&\t/340;s/./&\t/337;s/./&\t/334;s/./&\t/331;s/./&\t/329;s/./&\t/327;s/./&\t/325;s/./&\t/323;s/./&\t/320;s/./&\t/317;s/./&\t/314;s/./&\t/311;s/./&\t/310;s/./&\t/304;s/./&\t/300;s/./&\t/299;s/./&\t/296;s/./&\t/293;s/./&\t/290;s/./&\t/287;s/./&\t/284;s/./&\t/281;s/./&\t/279;s/./&\t/278;s/./&\t/277;s/./&\t/276;s/./&\t/275;s/./&\t/274;s/./&\t/273;s/./&\t/272;s/./&\t/271;s/./&\t/269;s/./&\t/267;s/./&\t/266;s/./&\t/265;s/./&\t/264;s/./&\t/259;s/./&\t/254;s/./&\t/245;s/./&\t/244;s/./&\t/241;s/./&\t/240;s/./&\t/238;s/./&\t/236;s/./&\t/235;s/./&\t/234;s/./&\t/233;s/./&\t/232;s/./&\t/229;s/./&\t/227;s/./&\t/225;s/./&\t/223;s/./&\t/220;s/./&\t/217;s/./&\t/207;s/./&\t/203;s/./&\t/198;s/./&\t/191;s/./&\t/190;s/./&\t/175;s/./&\t/174;s/./&\t/173;s/./&\t/169;s/./&\t/168;s/./&\t/167;s/./&\t/166;s/./&\t/165;s/./&\t/162;s/./&\t/161;s/./&\t/160;s/./&\t/158;s/./&\t/152;s/./&\t/146;s/./&\t/140;s/./&\t/137;s/./&\t/136;s/./&\t/135;s/./&\t/133;s/./&\t/131;s/./&\t/129;s/./&\t/127;s/./&\t/124;s/./&\t/121;s/./&\t/118;s/./&\t/115;s/./&\t/112;s/./&\t/109;s/./&\t/106;s/./&\t/104;s/./&\t/101;s/./&\t/98;s/./&\t/95;s/./&\t/94;s/./&\t/93;s/./&\t/92;s/./&\t/91;s/./&\t/87;s/./&\t/85;s/./&\t/72;s/./&\t/70;s/./&\t/68;s/./&\t/67;s/./&\t/65;s/./&\t/63;s/./&\t/60;s/./&\t/59;s/./&\t/58;s/./&\t/57;s/./&\t/56;s/./&\t/52;s/./&\t/51;s/./&\t/47;s/./&\t/46;s/./&\t/42;s/./&\t/38;s/./&\t/36;s/./&\t/34;s/./&\t/27;s/./&\t/24;s/./&\t/23;s/./&\t/22;s/./&\t/19;s/./&\t/18;s/./&\t/8' | tr -d " \r" > "$fileName"_seperated.txt
echo -e "Patient_ID\tRegistry_ID\tMarital_Status\tRace\tHNIA_Derived_Hispanic_Origin\tSex\tAge_at_diagnosis\tYear_of_Birth\tSequence_Number_Central\tMonth_of_Diagnosis\tYear_of_Diagnosis\tPrimary_Site\tLaterality\tHistology(92-100)ICD_O_2\tBehavior(92-100)ICO_2\tHistology_ICD_O_3\tBehavior_ICO_3\tGrade\tDiagnostic_Confirmation\tType_of_Reporting_Source\tEOD_Tumor_Size\tEOD_Extension\tEOD_Extension_Prost_Path\tEOD_Lymph_Node_Involv\tRegional_Nodes_Postive\tRegional_Node_Examined\tEOD_Old_13_Digit\tEOD_Old_2_Digit\tEOD_Old_4_Digit\tCoding_System_for_EOD\tTumor_Marker_1\tTumor_Marker_2\tTumor_Marker_3\tCS_Tumor_Size\tCS_Extension\tCS_lymph_Nodes\tCS_Mets_at_DX\tCS_Site_Specific_Factor_1\tCS_Site_Specific_Factor_2\tCS_Site_Specific_Factor_3\tCS_Site_Specific_Factor_4\tCS_Site_Specific_Factor_5\tCS_Site_Specific_Factor_6\tCS_Site_Specific_Factor_25\tDerived_AJCC_T\tDerived_AJCC_N\tDerived_AJCC_M\tDerived_AJCC_Stage_Group\tDerived_SS1977\tDerived_SS2000\tDerived_AJCC_Flag\tCS_Version_Input_Original\tCS_Version_Derived\tCS_Version_Input_Current\tRX_Summ_Surg_Prim_Site\tRX_Summ_Scope_Reg_LN_Sur\tRX_Summ_Surg_Oth_Reg_Dis\tRX_Summ_Reg_LN_Examined\tReason_for_no_surgery\tRX_Summ_Radiation\tRX_Summ_Rad_to_CNS\tRX_Summ_Surg_Rad_Seq\tRX_Summ_Surgery_Type\tRX_Summ_Scope_Reg_98_02\tRX_Summ_Surg_Oth_98_02\tSEER_Record_Number\tSEER_Type_of_Follow_up\tAge_Recode<1_Year_Olds\tSite_Recode_ICD_O_3_Who_2008\tRecode_ICD_O_2_to_9\tRecode_ICD_O_2_to_10\tICCC_site_recode_ICD_O_3_WHO_2008\tICCC_Site_rec_extended_ICD_O_3_WHO_2008\tBehavior_Recode_for_Analysis\tHistology_Recode_Broad_Groupings\tHistology_Recode_Brain_Groupings\tCS_Schema_v0204\tRace_Recode(White_Black_Other)\tRace_Recode(W_B_AI_API)\tOrigin_Recode(NHIA_Hispanic_Non_Hisp)\tSEER_Historic_Stage_A\tAJCC_stage_3rd_edition(1988_2003)\tSEER_modified_AJCC_Stage_3rd(1988-2003)\tSEER_Summary_Stage_1977(1995_2003)\tSEER_Summary_Stage(2001_2003)\tFirst_malignant_primary_indicator\tState_county_recode\tCause_of_Death_to_SEER_Site_recode\tCOD_to_site_rec_KM\tVital_Status_recode\tIHS_Link\tSummary_Stage_2000(1998+)\tAYA_site_recode_WHO_2008\tLymphoma_subtype_recode_WHO_2008\tSEER_Cause_Specific_Death_Classification\tSEER_Other_Cause_of_Death_Classification\tCS_Tumor_Size_Ext_Eval\tCS_Lymph_Nodes_Eval\tCS_Mets_Eval\tPrimary_by_international_rules\tER_Status_Recode_Breast_Cancer(1990+)\tPR_Status_Recode_Breast_Cancer(1990+)\tCS_Schema_AJCC_6th_ed(Previously_called_v1)\tCS_Site_Specific_Factor_8\tCS_Site_Specific_Factor_10\tCS_Site_Specific_Factor_11\tCS_Site_Specific_Factor_13\tCS_Site_Specific_Factor_15\tCS_Site_Specific_Factor_16\tLymph_vascular_invasion\tSurvival_months\tSurvival_months_flag\tInsurance_recode(2007+)\tDerived_AJCC_7_T\tDerived_AJCC_7_N\tDerived_AJCC_7_M\tDerived_AJCC_7_Stage_Grp\tBreast_Adjusted_AJCC_6th_T(1988+)\tBreast_Adjusted_AJCC_6th_N(1988+)\tBreast_Adjusted_AJCC_6th_M(1988+)\tBreast_Adjusted_AJCC_6th_Stage(1988+)\tCS_Site_Specific_Factor_7\tCS_Site_Specific_Factor_9\tCS_Site_Specific_Factor_12\tDerived_HER2_Recode(2010+)\tBreast_Subtype(2010+)\tLymphomas_Ann_Arbor_Staging(1983+)\tCS_Mets_at_Dx_Bone\tCS_Mets_at_Dx_Brain\tCS_Mets_at_Dx_Liver\tCS_Mets_at_Dx_Lung\tT_value_based_on_AJCC_3rd(1988_2003)\tN_value_based_on_AJCC_3rd(1988_2003)\tM_value_based_on_AJCC_3rd(1988_2003)" | cat - "$fileName"_seperated.txt > /tmp/out && mv /tmp/out "$fileName"_seperated.txt

cat $i  | sed -r 's/./&,/356;s/./&,/354;s/./&,/352;s/./&,/351;s/./&,/350;s/./&,/349;s/./&,/348;s/./&,/347;s/./&,/341;s/./&,/340;s/./&,/337;s/./&,/334;s/./&,/331;s/./&,/329;s/./&,/327;s/./&,/325;s/./&,/323;s/./&,/320;s/./&,/317;s/./&,/314;s/./&,/311;s/./&,/310;s/./&,/304;s/./&,/300;s/./&,/299;s/./&,/296;s/./&,/293;s/./&,/290;s/./&,/287;s/./&,/284;s/./&,/281;s/./&,/279;s/./&,/278;s/./&,/277;s/./&,/276;s/./&,/275;s/./&,/274;s/./&,/273;s/./&,/272;s/./&,/271;s/./&,/269;s/./&,/267;s/./&,/266;s/./&,/265;s/./&,/264;s/./&,/259;s/./&,/254;s/./&,/245;s/./&,/244;s/./&,/241;s/./&,/240;s/./&,/238;s/./&,/236;s/./&,/235;s/./&,/234;s/./&,/233;s/./&,/232;s/./&,/229;s/./&,/227;s/./&,/225;s/./&,/223;s/./&,/220;s/./&,/217;s/./&,/207;s/./&,/203;s/./&,/198;s/./&,/191;s/./&,/190;s/./&,/175;s/./&,/174;s/./&,/173;s/./&,/169;s/./&,/168;s/./&,/167;s/./&,/166;s/./&,/165;s/./&,/162;s/./&,/161;s/./&,/160;s/./&,/158;s/./&,/152;s/./&,/146;s/./&,/140;s/./&,/137;s/./&,/136;s/./&,/135;s/./&,/133;s/./&,/131;s/./&,/129;s/./&,/127;s/./&,/124;s/./&,/121;s/./&,/118;s/./&,/115;s/./&,/112;s/./&,/109;s/./&,/106;s/./&,/104;s/./&,/101;s/./&,/98;s/./&,/95;s/./&,/94;s/./&,/93;s/./&,/92;s/./&,/91;s/./&,/87;s/./&,/85;s/./&,/72;s/./&,/70;s/./&,/68;s/./&,/67;s/./&,/65;s/./&,/63;s/./&,/60;s/./&,/59;s/./&,/58;s/./&,/57;s/./&,/56;s/./&,/52;s/./&,/51;s/./&,/47;s/./&,/46;s/./&,/42;s/./&,/38;s/./&,/36;s/./&,/34;s/./&,/27;s/./&,/24;s/./&,/23;s/./&,/22;s/./&,/19;s/./&,/18;s/./&,/8' | tr -d " \r" > "$fileName"_seperated.csv
echo -e "Patient_ID,Registry_ID,Marital_Status,Race,HNIA_Derived_Hispanic_Origin,Sex,Age_at_diagnosis,Year_of_Birth,Sequence_Number_Central,Month_of_Diagnosis,Year_of_Diagnosis,Primary_Site,Laterality,Histology(92-100)ICD_O_2,Behavior(92-100)ICO_2,Histology_ICD_O_3,Behavior_ICO_3,Grade,Diagnostic_Confirmation,Type_of_Reporting_Source,EOD_Tumor_Size,EOD_Extension,EOD_Extension_Prost_Path,EOD_Lymph_Node_Involv,Regional_Nodes_Postive,Regional_Node_Examined,EOD_Old_13_Digit,EOD_Old_2_Digit,EOD_Old_4_Digit,Coding_System_for_EOD,Tumor_Marker_1,Tumor_Marker_2,Tumor_Marker_3,CS_Tumor_Size,CS_Extension,CS_lymph_Nodes,CS_Mets_at_DX,CS_Site_Specific_Factor_1,CS_Site_Specific_Factor_2,CS_Site_Specific_Factor_3,CS_Site_Specific_Factor_4,CS_Site_Specific_Factor_5,CS_Site_Specific_Factor_6,CS_Site_Specific_Factor_25,Derived_AJCC_T,Derived_AJCC_N,Derived_AJCC_M,Derived_AJCC_Stage_Group,Derived_SS1977,Derived_SS2000,Derived_AJCC_Flag,CS_Version_Input_Original,CS_Version_Derived,CS_Version_Input_Current,RX_Summ_Surg_Prim_Site,RX_Summ_Scope_Reg_LN_Sur,RX_Summ_Surg_Oth_Reg_Dis,RX_Summ_Reg_LN_Examined,Reason_for_no_surgery,RX_Summ_Radiation,RX_Summ_Rad_to_CNS,RX_Summ_Surg_Rad_Seq,RX_Summ_Surgery_Type,RX_Summ_Scope_Reg_98_02,RX_Summ_Surg_Oth_98_02,SEER_Record_Number,SEER_Type_of_Follow_up,Age_Recode<1_Year_Olds,Site_Recode_ICD_O_3_Who_2008,Recode_ICD_O_2_to_9,Recode_ICD_O_2_to_10,ICCC_site_recode_ICD_O_3_WHO_2008,ICCC_Site_rec_extended_ICD_O_3_WHO_2008,Behavior_Recode_for_Analysis,Histology_Recode_Broad_Groupings,Histology_Recode_Brain_Groupings,CS_Schema_v0204,Race_Recode(White_Black_Other),Race_Recode(W_B_AI_API),Origin_Recode(NHIA_Hispanic_Non_Hisp),SEER_Historic_Stage_A,AJCC_stage_3rd_edition(1988_2003),SEER_modified_AJCC_Stage_3rd(1988-2003),SEER_Summary_Stage_1977(1995_2003),SEER_Summary_Stage(2001_2003),First_malignant_primary_indicator,State_county_recode,Cause_of_Death_to_SEER_Site_recode,COD_to_site_rec_KM,Vital_Status_recode,IHS_Link,Summary_Stage_2000(1998+),AYA_site_recode_WHO_2008,Lymphoma_subtype_recode_WHO_2008,SEER_Cause_Specific_Death_Classification,SEER_Other_Cause_of_Death_Classification,CS_Tumor_Size_Ext_Eval,CS_Lymph_Nodes_Eval,CS_Mets_Eval,Primary_by_international_rules,ER_Status_Recode_Breast_Cancer(1990+),PR_Status_Recode_Breast_Cancer(1990+),CS_Schema_AJCC_6th_ed(Previously_called_v1),CS_Site_Specific_Factor_8,CS_Site_Specific_Factor_10,CS_Site_Specific_Factor_11,CS_Site_Specific_Factor_13,CS_Site_Specific_Factor_15,CS_Site_Specific_Factor_16,Lymph_vascular_invasion,Survival_months,Survival_months_flag,Insurance_recode(2007+),Derived_AJCC_7_T,Derived_AJCC_7_N,Derived_AJCC_7_M,Derived_AJCC_7_Stage_Grp,Breast_Adjusted_AJCC_6th_T(1988+),Breast_Adjusted_AJCC_6th_N(1988+),Breast_Adjusted_AJCC_6th_M(1988+),Breast_Adjusted_AJCC_6th_Stage(1988+),CS_Site_Specific_Factor_7,CS_Site_Specific_Factor_9,CS_Site_Specific_Factor_12,Derived_HER2_Recode(2010+),Breast_Subtype(2010+),Lymphomas_Ann_Arbor_Staging(1983+),CS_Mets_at_Dx_Bone,CS_Mets_at_Dx_Brain,CS_Mets_at_Dx_Liver,CS_Mets_at_Dx_Lung,T_value_based_on_AJCC_3rd(1988_2003),N_value_based_on_AJCC_3rd(1988_2003),M_value_based_on_AJCC_3rd(1988_2003)" | cat - "$fileName"_seperated.csv > /tmp/out && mv /tmp/out "$fileName"_seperated.csv

done
